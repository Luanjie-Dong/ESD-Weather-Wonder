_format_version: "3.0"

services:
  #######################################
  # USER MICROSERVICE
  #######################################
  - name: user-api
    url: http://user:5001
    routes:
      #/signup
      - name: create-user
        paths:
          - /api/v1/
        methods:
          - POST
        strip_path: True

      #/user/<string:user_id>
      - name: get-user
        paths:
          - /api/v1/
        methods:
          - GET
        strip_path: True

      #/user/<string:user_id>
      - name: update-user
        paths:
          - /api/v1/
        methods:
          - PUT
        strip_path: True

      #/user/<string:user_id>
      - name: delete-user
        paths:
          - /api/v1/
        methods:
          - DELETE
        strip_path: True

      #/reset_password/<string:user_id>
      - name: reset-password
        paths:
          - /api/v1/
        methods:
          - PUT
        strip_path: True
        
    plugins:
      - name: key-auth
        config:
          key_names:
            - weatherwonderapi_key
          key_in_header: true
          key_in_query: false

  #######################################
  # USER LOCATION MICROSERVICE
  #######################################
  - name: user-location-api
    url: https://personal-05fimycq.outsystemscloud.com/UserLocation/rest/v1
    routes:
      #/CreateUserLocation
      - name: create-user-location
        paths:
          - /api/v1/
        methods:
          - POST
        strip_path: True


      #/DeleteUserLocation
      - name: delete-user-location
        paths:
          - /api/v1/
        methods:
          - DELETE
        strip_path: True
      

      #/GetUserLocations/user/{UserId}
      - name: get-user-locations
        paths:
          - /api/v1/
        methods:
          - GET
        strip_path: True
        
      #/UpdateUserLocation
      - name: update-user-location
        paths:
          - /api/v1/
        methods:
          - PATCH
        strip_path: True

    plugins:
      - name: key-auth
        config:
          key_names:
            - weatherwonderapi_key
          key_in_header: true
          key_in_query: false
  #######################################
  # LOCATION WEATHER MICROSERVICE
  #######################################
  - name: location-weather-api
    url: http://location_weather:5003
    routes:
      # /get_weather/<location_id>
      - name: get-weather
        paths:
          - /api/v1/
        methods:
          - GET
        strip_path: True

      # /get_weather/date/<location_id>/<date>
      - name: get-weather-by-date
        paths:
          - /api/v1/
        methods:
          - GET
        strip_path: True

      # /get_weather/datetime/<location_id>/<dt_input>
      - name: get-weather-by-datetime
        paths:
          - /api/v1/
        methods:
          - GET
        strip_path: True
      
    plugins:
      - name: key-auth
        config:
          key_names:
            - weatherwonderapi_key
          key_in_header: true
          key_in_query: false    

  #######################################
  # ADD A LOCATION MICROSERVICE
  #######################################
  - name: add-user-location-api
    url: http://add_a_location:5010
    routes:
      # /add_location
      - name: add-location
        paths:
          - /api/v1/
        methods:
          - POST
        strip_path: True
      
    plugins:
      - name: key-auth
        config:
          key_names:
            - weatherwonderapi_key
          key_in_header: true
          key_in_query: false
      



#######################################
# AUTHENTICATION KEY
#######################################
consumers:
  - username: weatherwonder_app
    keyauth_credentials:
      - key: abc123xyz

#######################################
# PLUGINS
#######################################
plugins:
  - name: rate-limiting
    config:
      minute: 100
      policy: "local"
      limit_by: "ip"
  - name: cors
    config:
      origins:
        - "*"  
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
      credentials: false  
      max_age: 3600